load "$NCARG_ROOT/lib/ncarg/nclscripts/csm/gsn_code.ncl"
load "$NCARG_ROOT/lib/ncarg/nclscripts/wrf/WRFUserARW.ncl"

begin
  FILES = systemfunc (" ls -1 " + "wrfout* ")
  a = addfiles(FILES+".nc","r")
  times = wrf_user_getvar(a,"times",-1)  ; get all times in the file
  ntimes = dimsizes(times)               ; number of times in the file

  tend_int = 1
  do it = 0,ntimes-1,tend_int

    cinfo = wrf_user_getvar(a[it],"cape_2d",-1)

    ; cape thunderstorm index
    mcape = cinfo(0,0,:,:)
    mcape@description = "CAPE"

    ; other indices, will be used later
    ;mcin  = cinfo(1,.....)
    ;lcl  = cinfo(2,.....)
    ;lfc  = cinfo(3,.....)

    wks_type = "png"
    wks_type@wkWidth = 2500
    wks_type@wkHeight = 2500
    time_array = str_split(times(it), ":")
    wks = gsn_open_wks(wks_type,"thunderstorm_" + time_array(0))

    ; plotting options
    pltres = True                                ; Plotting resources
    mpres = True                                 ; Map resource
    mpres@mpGeophysicalLineColor = "Black"
    mpres@mpGeophysicalLineThicknessF = "2"
    mpres@mpFillBoundarySets = "AllBoundaries"
    mpres@mpNationalLineColor    = "Black"
    mpres@mpGridLineColor        = "Black"
    mpres@mpLimbLineColor        = "Black"
    mpres@mpPerimLineColor       = "Black"
    mpres@mpDataBaseVersion      = "HighRes"

    res = True
    res@MainTitle = "WRF: Thunderstorm index CAPE"
    res@TimeLabel = times(it)
    res@cnFillOn              = True            ; turn on color
    res@cnLinesOn             = False           ; turn off contour lines
    res@gsnSpreadColors       = True            ; use entire color map
    res@lbLabelAutoStride     = True            ; let NCL determine label spacing

    res@UnitLabel            = "Energy in J/kg"
    res@cnLevelSelectionMode = "ExplicitLevels"
    res@cnLevels             = (/ 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, \
                                    4500/)
    res@cnFillColors         = (/"DarkOliveGreen1", "Green", "Yellow2", "Yellow",\
                                 "Orange", "OrangeRed2", "Red", "Magenta", "Magenta3"/)
    res@cnInfoLabelOn        = False
    res@cnConstFLabelOn      = False
    res@cnFillOn             = True

    pltres = True
    pltres@PanelPlot = True
    pltres@FramePlot = False
    contour_tot = wrf_contour(a[it],wks, mcape, res)
    plot = wrf_map_overlays(a[it],wks,contour_tot,pltres,mpres)
    draw(plot)
    frame(wks)

  end do

end
